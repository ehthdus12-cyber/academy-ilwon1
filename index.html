<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강남일원독서실 아카데미 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        @font-face {
            font-family: 'SeoulNamsanL';
            src: url('https://cdn.jsdelivr.net/gh/seoulcity/seoulfonts@1.0/SeoulNamsanL.woff') format('woff');
        }
        body { font-family: 'SeoulNamsanL', 'Noto Sans KR', sans-serif; background-color: #f8fafc; letter-spacing: -0.02em; }
        .font-black { font-weight: 900; }
        .card-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen pb-20 font-medium">

    <!-- 헤더 -->
    <header class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-black text-blue-600 cursor-pointer" onclick="location.reload()">강남일원독서실</h1>
            <div class="flex gap-2">
                <button onclick="setView('search')" class="text-xs font-bold text-gray-500 bg-gray-50 px-3 py-2 rounded-xl border">조회</button>
                <button onclick="handleAdminAuth()" class="text-xs font-bold bg-blue-600 text-white px-3 py-2 rounded-xl shadow-sm">관리</button>
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto px-4 mt-8">
        
        <!-- [1] 신청 폼 뷰 -->
        <section id="view-form" class="bg-white rounded-[2.5rem] card-shadow overflow-hidden border border-gray-100">
            <div class="bg-blue-600 p-10 text-white text-center">
                <p class="text-sm opacity-80 mb-1 font-medium italic">지식과 꿈이 자라는 공간!</p>
                <h2 class="text-2xl font-black tracking-tight">아카데미 수강신청</h2>
                <div class="mt-4 inline-block bg-white/20 px-4 py-1 rounded-full text-[10px] font-bold" id="display-season">2026년 03월 시즌</div>
            </div>

            <form onsubmit="handleApply(event)" class="p-8 space-y-6">
                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-gray-400 ml-1 uppercase">수강생 성함</label>
                    <input type="text" id="reg-name" required placeholder="성함 입력" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-gray-400 ml-1 uppercase">연락처</label>
                    <input type="tel" id="reg-phone" required placeholder="010-0000-0000" oninput="onPhoneInput(this.value)" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none font-mono">
                    <div id="phone-badge"></div>
                </div>

                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-gray-400 ml-1 uppercase">생년월일</label>
                    <input type="text" id="reg-birth" required placeholder="YYYY-MM-DD" oninput="onBirthInput(this.value)" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl font-mono">
                </div>

                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-gray-400 ml-1 uppercase">수강 강좌 (실시간 현황)</label>
                    <select id="reg-course" required onchange="calculatePrice()" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl font-bold appearance-none outline-none">
                        <option value="">생년월일을 먼저 입력하세요</option>
                    </select>
                </div>

                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-gray-400 ml-1 uppercase">감면 혜택</label>
                    <select id="reg-discount" onchange="calculatePrice()" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none">
                        <option value="0">해당없음</option>
                        <option value="0.3">30% 감면 (다자녀/다강좌)</option>
                        <option value="0.5">50% 감면 (수급자/장애인/유공자)</option>
                    </select>
                </div>

                <div class="bg-blue-50 rounded-2xl p-6 flex justify-between items-center border border-blue-100">
                    <span class="text-xs font-bold text-blue-800">최종 납부액</span>
                    <span id="display-price" class="text-3xl font-black text-blue-600">0원</span>
                </div>

                <button type="submit" class="w-full py-5 bg-blue-600 text-white font-black rounded-2xl shadow-xl active:scale-95 text-xl">신청하기</button>
            </form>
        </section>

        <!-- [2] 관리자 뷰 -->
        <section id="view-admin" class="hidden space-y-6">
            <div class="bg-white rounded-3xl border shadow-sm p-3 flex gap-2 font-bold">
                <button onclick="setAdminTab('apps')" id="btn-tab-apps" class="flex-1 py-3 rounded-2xl transition-all bg-blue-600 text-white shadow-md">접수내역</button>
                <button onclick="setAdminTab('bulk')" id="btn-tab-bulk" class="flex-1 py-3 rounded-2xl transition-all bg-gray-50 text-gray-500">일괄입력</button>
                <button onclick="setAdminTab('settings')" id="btn-tab-settings" class="flex-1 py-3 rounded-2xl transition-all bg-gray-50 text-gray-500">설정</button>
            </div>

            <!-- 접수 내역 탭 -->
            <div id="admin-apps" class="space-y-4">
                <div class="bg-white p-6 rounded-3xl border shadow-sm flex flex-col md:flex-row gap-4 items-center">
                    <input type="text" id="admin-search" oninput="renderAdminApps()" placeholder="이름 검색..." class="flex-1 p-3 bg-gray-50 border rounded-xl outline-none text-sm w-full">
                    <button onclick="exportToCSV()" class="w-full md:w-auto px-4 py-3 bg-green-600 text-white rounded-xl text-xs font-bold">엑셀 다운로드</button>
                </div>
                <div id="admin-list" class="space-y-4"></div>
            </div>

            <!-- 일괄 입력 탭 -->
            <div id="admin-bulk" class="hidden bg-white p-8 rounded-[2.5rem] border shadow-sm space-y-6">
                <h3 class="text-lg font-black italic text-blue-600">Excel 데이터 일괄 등록</h3>
                <p class="text-xs text-gray-400">엑셀의 [이름, 전화번호] 열을 복사해서 붙여넣으세요. (구분자: 탭 또는 쉼표)</p>
                <textarea id="bulk-input" rows="8" placeholder="홍길동 010-1234-5678&#10;이순신 010-1111-2222" class="w-full p-4 bg-gray-50 border rounded-2xl font-mono text-sm outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <button onclick="processBulkImport()" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-black">데이터 일괄 추가</button>
                <div id="std-list-summary" class="text-sm font-bold text-blue-600 mt-4"></div>
            </div>

            <!-- 운영 설정 탭 -->
            <div id="admin-settings" class="hidden bg-white p-8 rounded-[2.5rem] border shadow-sm space-y-8">
                <div>
                    <label class="text-xs font-black text-gray-400 block mb-2">운영 시즌명</label>
                    <input type="text" id="set-season" class="w-full p-4 bg-gray-50 border rounded-2xl font-black">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 text-xs font-black text-blue-600 border-l-4 border-blue-600 pl-2">기존 수강생 접수 기간</div>
                    <input type="datetime-local" id="set-ex-start" class="p-3 bg-gray-50 border rounded-xl text-xs">
                    <input type="datetime-local" id="set-ex-end" class="p-3 bg-gray-50 border rounded-xl text-xs">
                    
                    <div class="col-span-2 text-xs font-black text-emerald-600 border-l-4 border-emerald-600 pl-2 mt-4">신규 수강생 접수 기간</div>
                    <input type="datetime-local" id="set-new-start" class="p-3 bg-gray-50 border rounded-xl text-xs">
                    <input type="datetime-local" id="set-new-end" class="p-3 bg-gray-50 border rounded-xl text-xs">
                </div>
                <button onclick="saveSettings()" class="w-full py-5 bg-blue-600 text-white rounded-3xl font-black shadow-lg">설정값 저장 및 적용</button>
            </div>
        </section>

        <!-- [3] 성공 화면 -->
        <section id="view-success" class="hidden bg-white rounded-[3rem] shadow-2xl p-10 text-center space-y-10 border border-gray-100">
            <div class="w-24 h-24 bg-green-50 text-green-600 rounded-[2rem] flex items-center justify-center mx-auto"><i data-lucide="check-circle" class="w-14 h-14"></i></div>
            <div>
                <h2 class="text-4xl font-black text-gray-800 tracking-tighter" id="success-title">신청 완료</h2>
                <p class="text-gray-400 mt-2 font-medium" id="success-desc">접수가 정상적으로 처리되었습니다.</p>
            </div>
            <div class="bg-gray-50 rounded-[2.5rem] p-8 text-left space-y-4 border border-gray-100">
                <div class="flex justify-between font-bold"><span>수강생</span><span id="res-name" class="text-lg"></span></div>
                <div class="flex justify-between font-bold"><span>신청 강좌</span><span id="res-course" class="text-blue-600"></span></div>
                <div class="flex justify-between border-t pt-4 font-black text-2xl"><span>최종 수강료</span><span id="res-price"></span></div>
                <div class="mt-6 bg-blue-600 p-8 rounded-[2rem] text-white shadow-xl">
                    <p class="text-[10px] opacity-60 font-black uppercase mb-1">Deposit Information</p>
                    <p class="text-base font-bold font-mono leading-relaxed mb-4">우리은행 1005-204-639684<br>(강남일원독서실)</p>
                    <p class="text-[10px] opacity-60 font-black uppercase mb-1">Depositor Name</p>
                    <p id="res-depositor" class="text-2xl font-black"></p>
                </div>
            </div>
            <button onclick="location.reload()" class="w-full py-5 bg-gray-100 text-gray-500 font-black rounded-3xl">홈으로 이동</button>
        </section>

    </main>

    <!-- 결제 관리 모달 -->
    <div id="modal-pay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-10 shadow-2xl">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-black italic">입금 확인 처리</h3>
                <button onclick="closeModal()"><i data-lucide="x" class="text-gray-300"></i></button>
            </div>
            <div class="space-y-4">
                <input type="date" id="pay-date" class="w-full p-4 bg-gray-50 border rounded-2xl font-mono">
                <input type="number" id="pay-amt" placeholder="실제 입금액" class="w-full p-4 bg-gray-50 border rounded-2xl font-black text-xl">
                <button id="btn-confirm-pay" class="w-full py-5 bg-blue-600 text-white rounded-2xl font-black shadow-lg">결제 완료 처리</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. 원본 강좌 데이터 ---
        const COURSES = [
            { id: 'ad1', name: 'AI스마트폰활용', price: 40000, type: 'adult', cap: 15, short: 'AI' },
            { id: 'ad2', name: '연필풍경스케치', price: 40000, type: 'adult', cap: 15, short: '스케치' },
            { id: 'ad3', name: '보타니컬아트', price: 40000, type: 'adult', cap: 15, short: '아트' },
            { id: 'yt1', name: '창의미술 (초1~3)', price: 30000, type: 'youth', cap: 12, short: '미술' },
            { id: 'yt2', name: '창의논술 A (초1~2)', price: 30000, type: 'youth', cap: 12, short: '논술A' },
            { id: 'yt3', name: '이야기한국사 (초5~중2)', price: 30000, type: 'youth', cap: 15, short: '한국사' },
            { id: 'yt4', name: '중급리딩 (초1~6)', price: 50000, type: 'youth', cap: 15, short: '리딩' }
        ];

        // --- 2. 상태 관리 (LocalStorage 연동) ---
        let applications = JSON.parse(localStorage.getItem('acad_apps') || '[]');
        let students = JSON.parse(localStorage.getItem('acad_stds') || '["010-1234-5678"]');
        let settings = JSON.parse(localStorage.getItem('acad_sets') || JSON.stringify({
            season: '2026년 03월',
            exStart: '2026-02-01T09:00', exEnd: '2026-02-05T18:00',
            newStart: '2026-02-06T09:00', newEnd: '2026-02-28T18:00'
        }));

        window.onload = () => {
            document.getElementById('display-season').innerText = settings.season + ' 시즌';
            lucide.createIcons();
        };

        // --- 3. 핵심 로직: 접수 기간 체크 ---
        function checkPeriod(isEx) {
            const now = new Date();
            const exS = new Date(settings.exStart), exE = new Date(settings.exEnd);
            const newS = new Date(settings.newStart), newE = new Date(settings.newEnd);

            if (isEx) {
                return (now >= exS && now <= exE) || (now >= newS && now <= newE);
            } else {
                return (now >= newS && now <= newE);
            }
        }

        // --- 4. 신청 폼 제어 ---
        function onPhoneInput(val) {
            const badge = document.getElementById('phone-badge');
            const isEx = students.includes(val);
            if (isEx) {
                badge.innerHTML = '<span class="text-[10px] font-black bg-green-100 text-green-700 px-2 py-1 rounded-lg mt-1 inline-block">✓ 기존 수강생 우선접수 가능</span>';
            } else if (val.length >= 11) {
                badge.innerHTML = '<span class="text-[10px] font-black bg-blue-100 text-blue-700 px-2 py-1 rounded-lg mt-1 inline-block">신규 수강생 접수</span>';
            } else { badge.innerHTML = ''; }
        }

        function onBirthInput(val) {
            const year = parseInt(val.split('-')[0]);
            if (!year) return;
            const type = year <= 2007 ? 'adult' : 'youth';
            const select = document.getElementById('reg-course');
            let options = '<option value="">강좌를 선택하세요</option>';
            
            COURSES.filter(c => c.type === type).forEach(c => {
                const count = applications.filter(a => a.courseId === c.id && a.status !== 'cancelled').length;
                const isFull = count >= c.cap;
                options += `<option value="${c.id}" data-price="${c.price}" ${isFull ? 'class="text-orange-500"' : ''}>
                    ${c.name} ${isFull ? '(정원마감 - 대기접수)' : `(현황: ${count}/${c.cap}명)`}
                </option>`;
            });
            select.innerHTML = options;
        }

        function calculatePrice() {
            const select = document.getElementById('reg-course');
            const base = parseInt(select.options[select.selectedIndex]?.dataset.price || 0);
            const disc = parseFloat(document.getElementById('reg-discount').value);
            document.getElementById('display-price').innerText = (base * (1 - disc)).toLocaleString() + '원';
        }

        async function handleApply(e) {
            e.preventDefault();
            const phone = document.getElementById('reg-phone').value;
            const isEx = students.includes(phone);

            if (!checkPeriod(isEx)) {
                alert(isEx ? "기존 수강생 접수 기간이 아닙니다." : "신규 수강생 접수 기간이 아닙니다.");
                return;
            }

            const cId = document.getElementById('reg-course').value;
            const course = COURSES.find(c => c.id === cId);
            const count = applications.filter(a => a.courseId === cId && a.status !== 'cancelled').length;
            const status = count >= course.cap ? 'waiting_list' : 'waiting';

            const newApp = {
                id: Date.now(),
                name: document.getElementById('reg-name').value,
                phone: phone,
                courseId: cId,
                courseName: course.name,
                short: course.short,
                status: status,
                finalPrice: parseInt(document.getElementById('display-price').innerText.replace(/[^0-9]/g, '')),
                date: new Date().toISOString(),
                payDate: '', payAmt: 0
            };

            applications.push(newApp);
            localStorage.setItem('acad_apps', JSON.stringify(applications));
            showSuccess(newApp);
        }

        // --- 5. 관리자 기능 (일괄입력, 결제관리) ---
        function handleAdminAuth() {
            if (prompt("관리자 암호를 입력하세요.") === "874054") {
                setView('admin'); setAdminTab('apps');
            } else { alert("암호 오류"); }
        }

        function setAdminTab(tab) {
            document.querySelectorAll('#view-admin > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('admin-' + tab).classList.remove('hidden');
            document.querySelectorAll('#view-admin button').forEach(b => {
                b.classList.replace('bg-blue-600', 'bg-gray-50'); b.classList.replace('text-white', 'text-gray-500');
            });
            document.getElementById('btn-tab-' + tab).classList.replace('bg-gray-50', 'bg-blue-600');
            document.getElementById('btn-tab-' + tab).classList.replace('text-gray-500', 'text-white');
            if(tab === 'apps') renderAdminApps();
            if(tab === 'settings') loadSettings();
        }

        function processBulkImport() {
            const input = document.getElementById('bulk-input').value;
            const lines = input.trim().split('\n');
            let count = 0;
            lines.forEach(line => {
                const parts = line.split(/[\t, ]+/);
                const phone = parts.find(p => p.includes('010'));
                if (phone && !students.includes(phone)) {
                    students.push(phone); count++;
                }
            });
            localStorage.setItem('acad_stds', JSON.stringify(students));
            document.getElementById('std-list-summary').innerText = `성공적으로 ${count}명의 학생을 등록했습니다.`;
        }

        function renderAdminApps() {
            const kw = document.getElementById('admin-search').value.toLowerCase();
            const list = document.getElementById('admin-list');
            const filtered = applications.filter(a => a.name.toLowerCase().includes(kw)).reverse();

            list.innerHTML = filtered.map(a => `
                <div class="bg-white p-6 rounded-3xl border relative shadow-sm ${a.status==='cancelled'?'opacity-40 grayscale':''}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-black text-xl">${a.name} <span class="text-[11px] text-gray-400 ml-1">${a.phone}</span></h3>
                            <p class="text-sm font-bold text-blue-600 mt-1">${a.courseName}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase ${a.status==='paid'?'bg-green-500 text-white':(a.status==='waiting_list'?'bg-orange-500 text-white':'bg-yellow-400 text-gray-800')}">${a.status}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-6">
                        <button onclick="openPayModal(${a.id})" class="py-2.5 bg-blue-600 text-white rounded-xl text-[10px] font-black">입금처리</button>
                        <button onclick="updateStatus(${a.id}, 'cancelled')" class="py-2.5 bg-red-50 text-red-500 rounded-xl text-[10px] font-black">신청취소</button>
                    </div>
                </div>
            `).join('');
        }

        function updateStatus(id, stat) {
            applications = applications.map(a => a.id === id ? {...a, status: stat} : a);
            localStorage.setItem('acad_apps', JSON.stringify(applications)); renderAdminApps();
        }

        function openPayModal(id) {
            const app = applications.find(a => a.id === id);
            document.getElementById('pay-amt').value = app.finalPrice;
            document.getElementById('pay-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('modal-pay').classList.replace('hidden', 'flex');
            document.getElementById('btn-confirm-pay').onclick = () => {
                applications = applications.map(a => a.id === id ? {...a, status: 'paid', payDate: document.getElementById('pay-date').value, payAmt: document.getElementById('pay-amt').value} : a);
                localStorage.setItem('acad_apps', JSON.stringify(applications)); closeModal(); renderAdminApps();
            };
        }

        // --- 기타 유틸 ---
        function setView(v) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById('view-' + v).classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal-pay').classList.replace('flex', 'hidden'); }
        function loadSettings() {
            document.getElementById('set-season').value = settings.season;
            document.getElementById('set-ex-start').value = settings.exStart;
            document.getElementById('set-ex-end').value = settings.exEnd;
            document.getElementById('set-new-start').value = settings.newStart;
            document.getElementById('set-new-end').value = settings.newEnd;
        }
        function saveSettings() {
            settings = {
                season: document.getElementById('set-season').value,
                exStart: document.getElementById('set-ex-start').value, exEnd: document.getElementById('set-ex-end').value,
                newStart: document.getElementById('set-new-start').value, newEnd: document.getElementById('set-new-end').value
            };
            localStorage.setItem('acad_sets', JSON.stringify(settings)); alert("설정 저장 완료"); location.reload();
        }
        function showSuccess(app) {
            setView('success');
            document.getElementById('res-name').innerText = app.name;
            document.getElementById('res-course').innerText = app.courseName;
            document.getElementById('res-price').innerText = app.finalPrice.toLocaleString() + '원';
            document.getElementById('res-depositor').innerText = app.name + app.short;
            document.getElementById('success-title').innerText = app.status === 'waiting_list' ? '대기 접수 완료' : '신청 접수 완료';
            lucide.createIcons();
        }
        function exportToCSV() {
            const headers = ["이름", "연락처", "강좌", "상태", "결제금액", "입금일", "신청일"];
            const rows = applications.map(a => [a.name, a.phone, a.courseName, a.status, a.finalPrice, a.payDate || '-', a.date]);
            let csv = "\uFEFF" + headers.join(",") + "\n";
            rows.forEach(r => csv += r.join(",") + "\n");
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `강남일원_명단.csv`; link.click();
        }
    </script>
</body>
</html>

