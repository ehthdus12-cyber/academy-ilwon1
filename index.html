import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, query, deleteDoc, getDocs, addDoc, writeBatch } from 'firebase/firestore';
import { User, Phone, Calendar, BookOpen, Gift, CheckCircle, CreditCard, Settings, LogOut, Check, Search, Lock, Filter, X, ChevronRight, Info, AlertCircle, Trash2, Users, Clock, UserPlus, ClipboardList, RefreshCw, CalendarDays, Download } from 'lucide-react';

/**
 * FIREBASE CONFIGURATION
 * Note: When deploying outside this environment, replace the firebaseConfig object 
 * with your own Firebase Project settings found in the Firebase Console.
 */
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : {
      apiKey: "",
      authDomain: "",
      projectId: "",
      storageBucket: "",
      messagingSenderId: "",
      appId: ""
    };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'gangnam-academy-prod';

const FontStyle = () => (
  <style>{`
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
    
    body { 
      font-family: 'SeoulNamsanL', 'Noto Sans KR', sans-serif; 
      background-color: #f8fafc; 
      letter-spacing: -0.02em;
    }
    
    .font-bold-title {
      font-weight: 900;
      letter-spacing: -0.04em;
    }

    .input-focus:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    
    @font-face {
      font-family: 'SeoulNamsanL';
      src: url('https://cdn.jsdelivr.net/gh/seoulcity/seoulfonts@1.0/SeoulNamsanL.woff') format('woff');
      font-weight: normal;
      font-style: normal;
    }

    .custom-scrollbar::-webkit-scrollbar { width: 5px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
  `}</style>
);

const App = () => {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('form'); 
  const [loading, setLoading] = useState(false);
  const [applications, setApplications] = useState([]);
  const [existingStudents, setExistingStudents] = useState([]);
  const [settings, setSettings] = useState({
    existingStart: '', existingEnd: '',
    newStart: '', newEnd: '',
    targetMonth: '2026년 03월' 
  });
  
  // Admin & Search States
  const [adminPass, setAdminPass] = useState('');
  const [adminTab, setAdminTab] = useState('apps'); 
  const [adminFilterCourse, setAdminFilterCourse] = useState('all');
  const [adminSearchName, setAdminSearchName] = useState('');
  
  const [searchInfo, setSearchInfo] = useState({ name: '', phone: '', birth: '' });
  const [paymentEditId, setPaymentEditId] = useState(null);
  const [paymentInfo, setPaymentInfo] = useState({ date: new Date().toISOString().split('T')[0], amount: '' });
  
  // Student DB Management States
  const [newExistingPhone, setNewExistingPhone] = useState('');
  const [newExistingName, setNewExistingName] = useState('');
  const [bulkInput, setBulkInput] = useState('');

  // Form States
  const [formData, setFormData] = useState({ 
    name: '', phone: '', birth: '', discount: 'none', course: '', privacyAgree: false 
  });
  const [submittedData, setSubmittedData] = useState(null);
  const [cancelModal, setCancelModal] = useState(null); 

  // --- Auth Logic ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- Data Subscription ---
  useEffect(() => {
    if (!user) return;
    
    // Public path as per mandated rules
    const qApps = collection(db, 'artifacts', appId, 'public', 'data', 'applications');
    const unsubApps = onSnapshot(qApps, (snapshot) => {
      setApplications(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }, (error) => console.error(error));

    const qStudents = collection(db, 'artifacts', appId, 'public', 'data', 'existingStudents');
    const unsubStudents = onSnapshot(qStudents, (snapshot) => {
      setExistingStudents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }, (error) => console.error(error));

    const qSettings = collection(db, 'artifacts', appId, 'public', 'data', 'settings');
    const unsubSettings = onSnapshot(qSettings, (snapshot) => {
      if (!snapshot.empty) {
        setSettings(snapshot.docs[0].data());
      }
    }, (error) => console.error(error));

    return () => {
      unsubApps();
      unsubStudents();
      unsubSettings();
    };
  }, [user]);

  // --- Utilities ---
  const splitISO = (isoString) => {
    if (!isoString) return { date: '', time: '' };
    try {
      const parts = isoString.split('T');
      if (parts.length === 2) return { date: parts[0], time: parts[1].substring(0, 5) };
      const spaceParts = isoString.split(' ');
      if (spaceParts.length === 2) return { date: spaceParts[0], time: spaceParts[1].substring(0, 5) };
      return { date: '', time: '' };
    } catch (e) { return { date: '', time: '' }; }
  };

  const joinISO = (date, time) => (date && time ? `${date}T${time}` : '');

  const formatPhone = (val) => {
    const v = val.replace(/[^0-9]/g, "");
    if (v.length <= 3) return v;
    if (v.length <= 7) return `${v.slice(0, 3)}-${v.slice(3)}`;
    return `${v.slice(0, 3)}-${v.slice(3, 7)}-${v.slice(7, 11)}`;
  };

  const formatBirth = (val) => {
    const v = val.replace(/[^0-9]/g, "");
    if (v.length <= 4) return v;
    if (v.length <= 6) return `${v.slice(0, 4)}-${v.slice(4)}`;
    return `${v.slice(0, 4)}-${v.slice(4, 6)}-${v.slice(6, 8)}`;
  };

  const isExisting = useMemo(() => {
    return existingStudents.some(s => s.phone === formData.phone);
  }, [existingStudents, formData.phone]);

  const getShortCourseName = (fullName) => {
    if (!fullName) return '';
    const keywords = ['창의논술', '창의미술', '보타니컬', '연필풍경', '스마트폰', '세계사', '한국사', '입문리딩', '초급리딩', '중급리딩'];
    for (let key of keywords) {
      if (fullName.includes(key)) return key;
    }
    return fullName.replace(/\s/g, '').slice(0, 8);
  };

  // --- Capacity Settings ---
  const courses = useMemo(() => [
    // Adult: All 15
    { id: 'adult_ai', name: 'AI스마트폰활용', basePrice: 40000, capacity: 15 },
    { id: 'adult_sketch', name: '연필풍경스케치', basePrice: 40000, capacity: 15 },
    { id: 'adult_art', name: '보타니컬아트', basePrice: 40000, capacity: 15 },
    // Youth
    { id: 'youth_art', name: '창의미술(초등 1~3학년)', basePrice: 30000, capacity: 12 },
    { id: 'youth_essay_a', name: '창의논술 A (초등 1~2학년)', basePrice: 30000, capacity: 12 },
    { id: 'youth_essay_b', name: '창의논술 B (초등 3~4학년)', basePrice: 30000, capacity: 12 },
    { id: 'youth_essay_c', name: '창의논술 C (초등 5~6학년)', basePrice: 30000, capacity: 12 },
    { id: 'youth_essay_d', name: '창의논술 D (중등 1~3학년)', basePrice: 30000, capacity: 12 },
    { id: 'youth_history_w', name: '이야기세계사 (초5~중2)', basePrice: 30000, capacity: 15 },
    { id: 'youth_history_k', name: '이야기한국사 (초5~중2)', basePrice: 30000, capacity: 15 },
    { id: 'youth_read_1', name: '입문리딩 (초등 1~6학년)', basePrice: 50000, capacity: 15 },
    { id: 'youth_read_2', name: '초급리딩 (초등 1~6학년)', basePrice: 50000, capacity: 15 },
    { id: 'youth_read_3', name: '중급리딩 (초등 1~6학년)', basePrice: 50000, capacity: 15 },
  ], []);

  const birthYear = parseInt(formData.birth.split('-')[0]) || 0;
  const isAdult = birthYear > 0 && birthYear <= 2007;
  const isYouth = birthYear > 0 && birthYear >= 2008;

  const filteredCourses = useMemo(() => {
    if (isAdult) return courses.filter(c => c.id.startsWith('adult'));
    if (isYouth) return courses.filter(c => c.id.startsWith('youth'));
    return [];
  }, [isAdult, isYouth, courses]);

  const discounts = [
    { id: 'none', name: '해당없음', rate: 0 },
    { id: '30_youth', name: '30% 감면 (다자녀 청소년)', rate: 0.3 },
    { id: '30_multi2', name: '30% 감면 (1일 2개 강좌 수강)', rate: 0.3 },
    { id: '30_multi3', name: '30% 감면 (1주 3개 강좌 수강)', rate: 0.3 },
    { id: '50_basic', name: '50% 감면 (기초생활수급자)', rate: 0.5 },
    { id: '50_army', name: '50% 감면 (병역명문가)', rate: 0.5 },
    { id: '50_disability', name: '50% 감면 (장애인)', rate: 0.5 },
    { id: '50_single', name: '50% 감면 (한부모 가족)', rate: 0.5 },
    { id: '50_facility', name: '50% 감면 (사회복지시설 청소년)', rate: 0.5 },
    { id: '50_merit', name: '50% 감면 (국가유공자)', rate: 0.5 },
  ];

  const selectedCourse = courses.find(c => c.id === formData.course);
  const selectedDiscount = discounts.find(d => d.id === formData.discount);
  const finalPrice = selectedCourse ? selectedCourse.basePrice * (1 - selectedDiscount.rate) : 0;

  const checkPeriod = () => {
    const now = new Date();
    const exStart = settings.existingStart ? new Date(settings.existingStart) : null;
    const exEnd = settings.existingEnd ? new Date(settings.existingEnd) : null;
    const nStart = settings.newStart ? new Date(settings.newStart) : null;
    const nEnd = settings.newEnd ? new Date(settings.newEnd) : null;

    if (isExisting) {
      if (exStart && exEnd && now >= exStart && now <= exEnd) return true;
      if (nStart && nEnd && now >= nStart && now <= nEnd) return true;
      return false;
    } else {
      if (nStart && nEnd && now >= nStart && now <= nEnd) return true;
      return false;
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user) return;
    if (!formData.privacyAgree) return;

    if (!checkPeriod()) {
      setCancelModal({ 
        type: 'restricted', 
        message: isExisting ? '기존 수강생 접수 기간이 아닙니다.' : '신규 수강생 접수 기간이 아닙니다.' 
      });
      return;
    }
    
    setLoading(true);
    // Real-time capacity check for the current month
    const activeApps = applications.filter(a => a.course === formData.course && a.status !== 'cancelled' && a.targetMonth === settings.targetMonth);
    const isFull = activeApps.length >= selectedCourse.capacity;
    const initialStatus = isFull ? 'waiting_list' : 'waiting';

    try {
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'applications', crypto.randomUUID()), {
        ...formData,
        isExisting,
        courseName: selectedCourse.name,
        discountName: selectedDiscount.name,
        basePrice: selectedCourse.basePrice,
        discountAmount: selectedCourse.basePrice * selectedDiscount.rate,
        finalPrice,
        status: initialStatus,
        targetMonth: settings.targetMonth,
        createdAt: new Date().toISOString()
      });
      setSubmittedData({ ...formData, courseName: selectedCourse.name, finalPrice, status: initialStatus, targetMonth: settings.targetMonth });
      setView('success');
    } catch (err) {
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // --- Admin Logic ---
  const handleAdminAuth = (e) => {
    e.preventDefault();
    if (adminPass === '874054') setView('admin');
    else setCancelModal({ type: 'restricted', message: '비밀번호가 올바르지 않습니다.' });
  };

  const changeStatus = async (id, newStatus) => {
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'applications', id), {
      status: newStatus,
      paymentDate: null,
      paymentAmount: null
    });
  };

  const deleteExistingStudent = async (id) => {
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'existingStudents', id));
  };

  const handleExportCSV = () => {
    if (adminDisplayList.length === 0) return;
    const headers = ["성함", "연락처", "신청강좌", "생년월일", "상태", "수강월", "신청일"];
    const rows = adminDisplayList.map(app => [
      app.name, app.phone, app.courseName, app.birth, app.status, app.targetMonth, app.createdAt.split('T')[0]
    ]);
    let csvContent = "\uFEFF" + headers.join(",") + "\n";
    rows.forEach(row => csvContent += row.map(v => `"${v}"`).join(",") + "\n");
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
    link.download = `강남일원_명단_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  };

  const adminDisplayList = useMemo(() => {
    return applications.filter(a => (adminFilterCourse === 'all' || a.courseName === adminFilterCourse) && (adminSearchName === '' || a.name.includes(adminSearchName)));
  }, [applications, adminFilterCourse, adminSearchName]);

  const handlePeriodChange = (field, type, value) => {
    const current = splitISO(settings[field]);
    if (type === 'date') setSettings({...settings, [field]: joinISO(value, current.time || '09:00')});
    else setSettings({...settings, [field]: joinISO(current.date || new Date().toISOString().split('T')[0], value)});
  };

  const saveSettings = async () => {
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'settings');
    const snap = await getDocs(q);
    if (snap.empty) await addDoc(q, settings);
    else await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', snap.docs[0].id), settings);
    setCancelModal({ type: 'success', message: '설정이 저장되었습니다.' });
  };

  return (
    <div className="min-h-screen pb-20 font-medium">
      <FontStyle />
      <header className="bg-white border-b border-gray-100 sticky top-0 z-30 shadow-sm">
        <div className="max-w-xl mx-auto px-4 py-4 flex justify-between items-center">
          <h1 className="text-xl font-bold-title text-blue-600 cursor-pointer" onClick={() => setView('form')}>강남일원독서실</h1>
          <div className="flex gap-2">
            <button onClick={() => setView('search')} className="text-xs font-bold text-gray-600 bg-gray-50 px-3 py-2 rounded-xl border">조회</button>
            <button onClick={() => setView('admin_auth')} className="text-xs font-bold bg-blue-600 text-white px-3 py-2 rounded-xl shadow-sm">관리</button>
          </div>
        </div>
      </header>

      <main className="max-w-xl mx-auto px-4 mt-8">
        {view === 'form' && (
          <div className="bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100 animate-in fade-in duration-500">
            <div className="bg-blue-600 p-8 text-white text-center">
              <p className="text-sm opacity-90 mb-1 font-medium italic">지식과 꿈이 자라는 공간! 강남일원독서실</p>
              <h2 className="text-2xl font-bold-title tracking-tight">청소년 / 성인아카데미 수강신청</h2>
            </div>
            
            <form onSubmit={handleSubmit} className="p-8 space-y-6">
              <div className="space-y-1.5">
                <label className="text-xs font-bold text-gray-500 ml-1">수강생명</label>
                <input type="text" required value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} placeholder="이름 입력" className="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl input-focus font-medium" />
              </div>

              <div className="space-y-1.5">
                <label className="text-xs font-bold text-gray-500 ml-1">연락처</label>
                <input type="tel" required value={formData.phone} onChange={(e) => setFormData({...formData, phone: formatPhone(e.target.value)})} placeholder="010-0000-0000" className="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl input-focus font-mono" />
                {formData.phone.length >= 11 && (
                  <p className={`text-[10px] font-bold px-2 py-1 rounded-lg inline-block mt-1 animate-in fade-in ${isExisting ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                    {isExisting ? '✓ 기존 수강생(우선접수 대상)' : '신규 수강생'}
                  </p>
                )}
              </div>

              <div className="space-y-1.5">
                <label className="text-xs font-bold text-gray-500 ml-1">생년월일</label>
                <input type="text" required value={formData.birth} onChange={(e) => setFormData({...formData, birth: formatBirth(e.target.value)})} placeholder="1990-01-01" className="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl input-focus font-mono" />
              </div>

              {(isAdult || isYouth) && (
                <div className="space-y-1.5">
                  <label className="text-xs font-bold text-gray-500 ml-1">과목 선택 ({isAdult ? '성인' : '청소년'})</label>
                  <select required value={formData.course} onChange={(e) => setFormData({...formData, course: e.target.value})} className="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl input-focus appearance-none font-bold">
                    <option value="">과목을 선택해주세요</option>
                    {filteredCourses.map(c => {
                      const count = applications.filter(a => a.course === c.id && a.status !== 'cancelled' && a.targetMonth === settings.targetMonth).length;
                      const isFull = count >= c.capacity;
                      return (
                        <option key={c.id} value={c.id}>
                          {c.name} {isFull ? `(정원 마감 - 대기 접수)` : `(접수중: ${count}/${c.capacity}명)`}
                        </option>
                      );
                    })}
                  </select>
                </div>
              )}

              <div className="space-y-1.5">
                <label className="text-xs font-bold text-gray-500 ml-1">감면 혜택</label>
                <select value={formData.discount} onChange={(e) => setFormData({...formData, discount: e.target.value})} className="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl input-focus appearance-none">
                  {discounts.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                </select>
              </div>

              {selectedCourse && (
                <div className="bg-blue-50 rounded-2xl p-5 flex justify-between items-center border border-blue-100 animate-in slide-in-from-top-2">
                  <span className="text-xs font-bold text-blue-800">최종 납부 금액</span>
                  <span className="text-2xl font-black text-blue-600">{finalPrice.toLocaleString()}원</span>
                </div>
              )}

              <div className="flex items-center gap-2 p-1 cursor-pointer" onClick={() => setFormData({...formData, privacyAgree: !formData.privacyAgree})}>
                <input type="checkbox" id="agree" checked={formData.privacyAgree} readOnly className="w-4 h-4 rounded text-blue-600" />
                <label htmlFor="agree" className="text-[11px] text-gray-500 font-medium cursor-pointer">[필수] 개인정보 수집 및 이용 동의</label>
              </div>

              <button type="submit" disabled={loading} className="w-full py-5 bg-blue-600 text-white font-black rounded-2xl shadow-lg active:scale-95 disabled:opacity-50 text-xl">
                {loading ? '처리 중...' : '수강 신청하기'}
              </button>
            </form>
          </div>
        )}

        {view === 'admin' && (
          <div className="space-y-6 animate-in fade-in">
            <div className="bg-white rounded-3xl border shadow-sm p-3 flex gap-2 font-bold">
              <button onClick={() => setAdminTab('apps')} className={`flex-1 py-3 rounded-2xl transition-all ${adminTab === 'apps' ? 'bg-blue-600 text-white shadow-lg shadow-blue-100' : 'bg-gray-50 text-gray-500'}`}>접수내역</button>
              <button onClick={() => setAdminTab('students')} className={`flex-1 py-3 rounded-2xl transition-all ${adminTab === 'students' ? 'bg-blue-600 text-white shadow-lg shadow-blue-100' : 'bg-gray-50 text-gray-500'}`}>학생관리</button>
              <button onClick={() => setAdminTab('settings')} className={`flex-1 py-3 rounded-2xl transition-all ${adminTab === 'settings' ? 'bg-blue-600 text-white shadow-lg shadow-blue-100' : 'bg-gray-50 text-gray-500'}`}>기간설정</button>
            </div>

            {adminTab === 'apps' && (
              <div className="space-y-4">
                <div className="bg-white p-6 rounded-3xl border shadow-sm space-y-4 font-bold">
                  <div className="flex items-center gap-3 bg-gray-50 px-4 py-3 rounded-2xl border transition-all focus-within:bg-white focus-within:border-blue-200">
                    <Search size={16} className="text-gray-400" />
                    <input type="text" placeholder="이름 검색" value={adminSearchName} onChange={e => setAdminSearchName(e.target.value)} className="bg-transparent text-sm outline-none flex-1" />
                  </div>
                  <div className="flex items-center gap-2 bg-gray-50 px-4 py-3 rounded-2xl border">
                    <Filter size={14} className="text-gray-400" />
                    <select value={adminFilterCourse} onChange={e => setAdminFilterCourse(e.target.value)} className="bg-transparent text-xs font-bold outline-none flex-1 cursor-pointer">
                        <option value="all">모든 강좌</option>
                        {courses.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                    </select>
                  </div>
                </div>

                <div className="flex justify-between items-center px-2">
                    <span className="text-xs text-gray-400 font-black uppercase">Results ({adminDisplayList.length})</span>
                    <button onClick={handleExportCSV} className="flex items-center gap-1.5 px-3 py-1.5 bg-green-50 text-green-700 rounded-xl text-xs font-bold border border-green-100"><Download size={14} /> 엑셀 다운로드</button>
                </div>

                {adminDisplayList.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).map(app => (
                  <div key={app.id} className={`bg-white border p-6 rounded-3xl relative shadow-sm transition-all ${app.status === 'cancelled' ? 'opacity-50 grayscale' : ''}`}>
                    <div className="flex justify-between items-start mb-4">
                      <div>
                        <div className="flex items-center gap-2">
                           <h3 className="font-bold text-xl">{app.name}</h3>
                           <span className={`px-2 py-0.5 rounded-lg text-[10px] font-black ${app.isExisting ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{app.isExisting ? '기존' : '신규'}</span>
                        </div>
                        <p className="text-sm font-black text-blue-600 mt-1">{app.courseName}</p>
                        <p className="text-[10px] text-gray-400 mt-1 font-bold italic">수강 월: {app.targetMonth}</p>
                      </div>
                      <div className="text-right">
                         <span className={`text-[10px] font-black px-3 py-1 rounded-full uppercase ${app.status === 'paid' ? 'bg-green-500 text-white' : app.status === 'waiting_list' ? 'bg-orange-500 text-white' : app.status === 'cancelled' ? 'bg-red-500 text-white' : 'bg-yellow-400 text-gray-800'}`}>
                           {app.status === 'paid' ? 'PAID' : app.status === 'waiting_list' ? 'WAIT' : 'READY'}
                         </span>
                         <p className="text-[10px] text-gray-400 font-mono mt-2 font-bold">{app.createdAt.split('T')[0]}</p>
                      </div>
                    </div>
                    <div className="text-xs text-gray-500 grid grid-cols-2 gap-3 bg-gray-50 p-4 rounded-2xl border border-gray-100 font-medium">
                      <p>연락처: <span className="font-mono text-gray-900">{app.phone}</span></p>
                      <p>최종금액: <span className="font-bold text-gray-900">{app.finalPrice.toLocaleString()}원</span></p>
                    </div>
                    {app.status !== 'cancelled' && (
                      <div className="mt-4 flex gap-2 font-bold">
                        {app.status === 'waiting' ? (
                          <button onClick={() => { setPaymentEditId(app.id); setPaymentInfo({date: new Date().toISOString().split('T')[0], amount: app.finalPrice}); }} className="flex-1 py-2.5 bg-blue-600 text-white rounded-xl text-xs shadow-md">입금 확인</button>
                        ) : (
                          <button onClick={() => changeStatus(app.id, 'waiting')} className="flex-1 py-2.5 bg-gray-100 text-gray-500 rounded-xl text-xs">확인 취소</button>
                        )}
                        <button onClick={() => changeStatus(app.id, app.status === 'waiting_list' ? 'waiting' : 'waiting_list')} className={`flex-1 py-2.5 rounded-xl text-xs ${app.status === 'waiting_list' ? 'bg-blue-50 text-blue-600' : 'bg-orange-50 text-orange-600'}`}>
                           {app.status === 'waiting_list' ? '대기해제' : '대기등록'}
                        </button>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}

            {adminTab === 'students' && (
              <div className="space-y-6">
                <div className="bg-white border rounded-[2rem] p-8 shadow-sm font-bold">
                  <h3 className="font-bold text-gray-700 mb-5 flex justify-between items-center"><span>기존 수강생 명단</span><span className="text-blue-600 text-sm font-black">{existingStudents.length}명</span></h3>
                  <div className="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar pr-2">
                    {existingStudents.sort((a,b) => a.name.localeCompare(b.name)).map(s => (
                      <div key={s.id} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100 hover:bg-white transition-all">
                        <span className="text-sm font-bold text-gray-800">{s.name} <span className="font-normal text-gray-400 font-mono ml-3 text-xs">{s.phone}</span></span>
                        <button onClick={() => deleteExistingStudent(s.id)} className="text-gray-200 hover:text-red-500 transition-colors"><Trash2 size={16}/></button>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {adminTab === 'settings' && (
              <div className="space-y-6">
                <div className="bg-white border rounded-[2rem] p-8 shadow-sm font-bold">
                    <h3 className="font-bold text-gray-700 mb-6 flex items-center gap-2 text-sm uppercase tracking-widest border-b pb-4"><Settings size={16}/> 운영 시즌</h3>
                    <input type="text" value={settings.targetMonth} onChange={e => setSettings({...settings, targetMonth: e.target.value})} placeholder="예: 2026년 03월" className="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl text-sm font-bold outline-none shadow-inner" />
                </div>

                <div className="bg-white border rounded-[2rem] p-10 space-y-10 shadow-sm font-bold">
                  <div className="space-y-6">
                    <h3 className="text-sm font-black text-green-700 border-l-4 border-green-500 pl-3">Existing Student Period (기존)</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="date" value={splitISO(settings.existingStart).date} onChange={e => handlePeriodChange('existingStart', 'date', e.target.value)} className="p-4 bg-gray-50 border rounded-2xl font-mono text-sm" />
                        <input type="time" value={splitISO(settings.existingStart).time} onChange={e => handlePeriodChange('existingStart', 'time', e.target.value)} className="p-4 bg-gray-50 border rounded-2xl font-mono text-sm" />
                        <div className="text-center text-xs text-gray-300 md:col-span-2">~</div>
                        <input type="date" value={splitISO(settings.existingEnd).date} onChange={e => handlePeriodChange('existingEnd', 'date', e.target.value)} className="p-4 bg-gray-50 border rounded-2xl font-mono text-sm" />
                        <input type="time" value={splitISO(settings.existingEnd).time} onChange={e => handlePeriodChange('existingEnd', 'time', e.target.value)} className="p-4 bg-gray-50 border rounded-2xl font-mono text-sm" />
                    </div>
                  </div>

                  <div className="space-y-6 pt-4 border-t">
                    <h3 className="text-sm font-black text-blue-700 border-l-4 border-blue-500 pl-3">New Student Period (신규)</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="date" value={splitISO(settings.newStart).date} onChange={e => handlePeriodChange('newStart', 'date', e.target.value)} className="p-4 bg-gray-50 border rounded-2xl font-mono text-sm" />
                        <input type="time" value={splitISO(settings.newStart).time} onChange={e => handlePeriodChange('newStart', 'time', e.target.value)} className="p-4 bg-gray-50 border rounded-2xl font-mono text-sm" />
                        <div className="text-center text-xs text-gray-300 md:col-span-2">~</div>
                        <input type="date" value={splitISO(settings.newEnd).date} onChange={e => handlePeriodChange('newEnd', 'date', e.target.value)} className="p-4 bg-gray-50 border rounded-2xl font-mono text-sm" />
                        <input type="time" value={splitISO(settings.newEnd).time} onChange={e => handlePeriodChange('newEnd', 'time', e.target.value)} className="p-4 bg-gray-50 border rounded-2xl font-mono text-sm" />
                    </div>
                  </div>
                </div>
                <button onClick={saveSettings} className="w-full py-5 bg-blue-600 text-white font-bold-title rounded-3xl shadow-xl active:scale-95 transition-all text-lg">설정 저장 및 활성화</button>
              </div>
            )}
          </div>
        )}

        {view === 'success' && submittedData && (
          <div className="bg-white rounded-[3rem] shadow-2xl p-10 text-center space-y-10 animate-in zoom-in border border-gray-100 relative">
            <div className="w-24 h-24 bg-green-50 text-green-600 rounded-[2rem] flex items-center justify-center mx-auto"><CheckCircle size={56} /></div>
            <div>
              <h2 className="text-3xl font-bold-title text-gray-800 tracking-tight italic">{submittedData.status === 'waiting_list' ? '대기 접수 완료' : '신청 접수 완료'}</h2>
              <p className="text-gray-500 mt-2 font-medium">[{submittedData.targetMonth}] 신청이 성공적으로 완료되었습니다.</p>
            </div>
            <div className="bg-gray-50 rounded-[2.5rem] p-10 text-left space-y-6 font-bold font-medium border border-gray-100">
              <div className="space-y-4">
                 <div className="flex justify-between items-center text-sm"><span>성함</span><span className="text-lg">{submittedData.name}</span></div>
                 <div className="flex justify-between items-start text-sm"><span>신청 강좌</span><span className="text-blue-600 text-right font-black leading-tight ml-4">{submittedData.courseName}</span></div>
                 <div className="flex justify-between border-t pt-5 border-gray-200"><span>총 수강료</span><span className="text-2xl font-black">{submittedData.finalPrice.toLocaleString()}원</span></div>
              </div>
              {submittedData.status === 'waiting' && (
                <div className="bg-blue-600 p-8 rounded-[2rem] shadow-xl text-white mt-6">
                  <p className="text-[10px] opacity-70 mb-1 uppercase">Account Info</p>
                  <p className="text-base font-bold mb-5 font-mono leading-relaxed">우리은행 1005-204-639684<br/>(예금주: 강남일원독서실)</p>
                  <p className="text-[10px] opacity-70 mb-1 uppercase">Depositor Name</p>
                  <p className="text-2xl font-black">{submittedData.name}{getShortCourseName(submittedData.courseName)}</p>
                </div>
              )}
            </div>
            <button onClick={() => setView('form')} className="w-full py-5 bg-gray-100 text-gray-600 font-bold-title rounded-3xl transition-all">홈으로 돌아가기</button>
          </div>
        )}

        {view === 'search' && (
          <div className="bg-white rounded-[2.5rem] shadow-xl p-10 border border-gray-100 animate-in fade-in">
             <div className="text-center mb-10"><h2 className="text-2xl font-bold-title text-gray-800 italic uppercase">수강 신청 조회</h2></div>
             <form onSubmit={(e) => { e.preventDefault(); /* Logic to filter applications state if needed */ setView('form'); }} className="space-y-5 font-medium">
               <input type="text" placeholder="성함" className="w-full p-5 bg-gray-50 border rounded-3xl font-bold shadow-inner outline-none" />
               <input type="tel" placeholder="연락처" className="w-full p-5 bg-gray-50 border rounded-3xl font-mono shadow-inner outline-none" />
               <button type="submit" className="w-full py-5 bg-blue-600 text-white font-bold-title rounded-3xl shadow-xl active:scale-95 transition-all text-lg mt-4">조회하기</button>
               <button type="button" onClick={() => setView('form')} className="w-full py-4 text-gray-400 font-bold text-sm">홈으로</button>
             </form>
          </div>
        )}

        {view === 'admin_auth' && (
          <div className="bg-white rounded-[2.5rem] shadow-2xl p-12 border border-gray-100 max-w-sm mx-auto">
            <h2 className="text-xl font-bold-title mb-10 text-center text-gray-800 uppercase tracking-widest italic">Admin Login</h2>
            <form onSubmit={handleAdminAuth} className="space-y-6 text-center font-bold">
              <input type="password" placeholder="••••••" required value={adminPass} onChange={e => setAdminPass(e.target.value)} className="w-full p-6 bg-gray-50 border border-gray-100 rounded-3xl text-center text-4xl tracking-[0.5em] outline-none font-black shadow-inner focus:bg-white transition-all" />
              <button type="submit" className="w-full py-5 bg-gray-900 text-white font-bold-title rounded-[1.5rem] active:scale-95 transition-all text-lg shadow-xl shadow-gray-200">시스템 접속하기</button>
            </form>
          </div>
        )}

        {cancelModal && (
          <div className="fixed inset-0 bg-gray-900/70 backdrop-blur-md z-50 flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-10 shadow-2xl text-center animate-in zoom-in border border-gray-100 font-bold">
              <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 ${cancelModal.type === 'success' ? 'bg-green-50 text-green-500' : 'bg-red-50 text-red-500'}`}>
                {cancelModal.type === 'success' ? <CheckCircle size={36} /> : <AlertCircle size={36} />}
              </div>
              <p className="text-base text-gray-700 whitespace-pre-wrap leading-relaxed mb-8">{cancelModal.message}</p>
              <button onClick={() => setCancelModal(null)} className="w-full py-4 bg-gray-900 text-white font-bold-title rounded-2xl active:scale-95 transition-all">확인</button>
            </div>
          </div>
        )}

        {paymentEditId && (
          <div className="fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-sm rounded-[2rem] p-10 shadow-2xl animate-in zoom-in border border-gray-100 font-bold">
              <div className="flex justify-between items-center mb-8 px-1 italic"><h3 className="text-xl">입금 확인 처리</h3><button onClick={() => setPaymentEditId(null)} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><X size={20}/></button></div>
              <form onSubmit={handlePaymentUpdate} className="space-y-5">
                <div className="space-y-1.5"><label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Payment Date</label><input type="date" required value={paymentInfo.date} onChange={e => setPaymentInfo({...paymentInfo, date: e.target.value})} className="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl font-mono shadow-inner outline-none focus:bg-white" /></div>
                <div className="space-y-1.5"><label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Actual Amount</label><input type="number" required value={paymentInfo.amount} onChange={e => setPaymentInfo({...paymentInfo, amount: e.target.value})} className="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl font-black text-2xl font-mono shadow-inner outline-none focus:bg-white" /></div>
                <button type="submit" className="w-full py-5 bg-blue-600 text-white font-bold-title rounded-2xl shadow-xl mt-4 active:scale-95 transition-all text-lg font-black">결제 확인 완료</button>
              </form>
            </div>
          </div>
        )}
      </main>

      <footer className="max-w-xl mx-auto px-8 py-10 text-center font-medium opacity-20">
        <p className="text-[10px] font-bold-title tracking-widest italic uppercase tracking-[0.2em]">© 2024 Gangnam Irwon All Rights Reserved.</p>
      </footer>
    </div>
  );
};

export default App;